<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Waterscape</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.7.0/p5.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #0f0f0f 0%, #1a1a1a 100%);
            min-height: 100vh;
            display: flex;
            gap: 1px;
            color: #e4e4e7;
            overflow: hidden;
        }

        .controls {
            background: linear-gradient(180deg, #18181b 0%, #0f0f0f 100%);
            border-right: 1px solid #27272a;
            padding: 24px;
            width: 380px;
            height: 100vh;
            overflow-y: auto;
            box-shadow: 4px 0 24px rgba(0, 0, 0, 0.5);
        }

        .controls::-webkit-scrollbar {
            width: 6px;
        }

        .controls::-webkit-scrollbar-track {
            background: #18181b;
        }

        .controls::-webkit-scrollbar-thumb {
            background: #3f3f46;
            border-radius: 3px;
        }

        .controls::-webkit-scrollbar-thumb:hover {
            background: #52525b;
        }

        .canvas-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: #0a0a0a;
            padding: 32px;
            position: relative;
        }

        .app-header {
            text-align: center;
            margin-bottom: 32px;
            border-bottom: 1px solid #27272a;
            padding-bottom: 20px;
        }

        .app-title {
            font-size: 24px;
            font-weight: 700;
            color: #f4f4f5;
            letter-spacing: -0.02em;
            margin-bottom: 4px;
        }

        .app-subtitle {
            font-size: 13px;
            color: #71717a;
            font-weight: 400;
        }

        .control-section {
            margin-bottom: 28px;
            background: rgba(39, 39, 42, 0.3);
            border: 1px solid #27272a;
            border-radius: 12px;
            padding: 20px;
            backdrop-filter: blur(8px);
        }

        .section-header {
            color: #f4f4f5;
            margin-bottom: 16px;
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .section-header::before {
            content: '';
            width: 3px;
            height: 14px;
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            border-radius: 2px;
        }

        .control-item {
            margin-bottom: 20px;
        }

        .control-item:last-child {
            margin-bottom: 0;
        }

        .control-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            font-size: 13px;
            font-weight: 500;
            color: #d4d4d8;
        }

        .control-value {
            color: #3b82f6;
            font-weight: 600;
            font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
            font-size: 12px;
            background: rgba(59, 130, 246, 0.1);
            padding: 2px 6px;
            border-radius: 4px;
            border: 1px solid rgba(59, 130, 246, 0.2);
        }

        .slider {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #27272a;
            outline: none;
            -webkit-appearance: none;
            position: relative;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .slider:hover {
            background: #3f3f46;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            cursor: pointer;
            border: 2px solid #0f0f0f;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3), 
                        0 0 0 2px rgba(59, 130, 246, 0.1);
            transition: all 0.15s ease;
        }

        .slider::-webkit-slider-thumb:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4), 
                        0 0 0 3px rgba(59, 130, 246, 0.15);
        }

        .slider::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            cursor: pointer;
            border: 2px solid #0f0f0f;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
        }

        .dropdown {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #27272a;
            border-radius: 8px;
            background: #18181b;
            color: #e4e4e7;
            font-size: 13px;
            font-weight: 500;
            outline: none;
            transition: all 0.15s ease;
            cursor: pointer;
        }

        .dropdown:hover {
            border-color: #3f3f46;
            background: #1f1f23;
        }

        .dropdown:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
        }

        .button-group {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }

        .btn {
            flex: 1;
            padding: 12px 16px;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s ease;
            position: relative;
            overflow: hidden;
        }

        .btn-primary {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
            border: 1px solid rgba(59, 130, 246, 0.3);
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #2563eb, #1e40af);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .btn-secondary {
            background: rgba(34, 197, 94, 0.1);
            color: #22c55e;
            border: 1px solid rgba(34, 197, 94, 0.3);
        }

        .btn-secondary:hover {
            background: rgba(34, 197, 94, 0.2);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(34, 197, 94, 0.2);
        }

        .color-palette {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-bottom: 16px;
        }

        .color-swatch {
            width: 100%;
            height: 32px;
            border: 2px solid #27272a;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.15s ease;
            position: relative;
            overflow: hidden;
        }

        .color-swatch:hover {
            transform: scale(1.05);
            border-color: #3b82f6;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .color-swatch.active {
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3);
        }

        .canvas-wrapper {
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.6),
                        0 0 0 1px rgba(255, 255, 255, 0.05);
            background: white;
            position: relative;
        }

        .canvas-metadata {
            text-align: center;
            margin-top: 16px;
            color: #52525b;
            font-size: 12px;
            font-weight: 400;
            line-height: 1.4;
        }

        .canvas-metadata .primary-info {
            color: #71717a;
            font-weight: 500;
            margin-bottom: 4px;
        }

        .canvas-metadata .secondary-info {
            color: #3f3f46;
            font-size: 11px;
        }

        .version-info {
            position: absolute;
            bottom: 20px;
            left: 24px;
            font-size: 11px;
            color: #52525b;
            font-weight: 400;
        }

        @media (max-width: 1200px) {
            body {
                flex-direction: column;
                height: auto;
            }
            
            .controls {
                width: 100%;
                height: auto;
                max-height: 40vh;
                border-right: none;
                border-bottom: 1px solid #27272a;
            }
            
            .canvas-container {
                height: 60vh;
                padding: 20px;
            }
        }

        /* Custom focus styles for accessibility */
        .slider:focus-visible,
        .dropdown:focus-visible,
        .btn:focus-visible {
            outline: 2px solid #3b82f6;
            outline-offset: 2px;
        }
    </style>
</head>
<body>
    <div class="controls">
        <div class="app-header">
            <div class="app-title">Waterscape</div>
            <div class="app-subtitle">Generative Watercolor Studio</div>
        </div>
        
        <div class="control-section">
            <div class="section-header">Color Palette</div>
            <div class="color-palette" id="colorPalette"></div>
            <select class="dropdown" id="paletteSelect">
                <option value="vibrant">Vibrant</option>
                <option value="pastel">Pastel</option>
                <option value="earth">Earth Tones</option>
                <option value="ocean">Ocean</option>
                <option value="sunset">Sunset</option>
                <option value="forest">Forest</option>
                <option value="monochrome">Monochrome</option>
            </select>
        </div>

        <div class="control-section">
            <div class="section-header">Generation</div>
            
            <div class="control-item">
                <div class="control-label">
                    <span>Brush Count</span>
                    <span class="control-value" id="brushCountValue">12</span>
                </div>
                <input type="range" class="slider" id="brushCount" min="5" max="20" value="12">
            </div>

            <div class="control-item">
                <div class="control-label">
                    <span>Layers per Brush</span>
                    <span class="control-value" id="layersPerBrushValue">25</span>
                </div>
                <input type="range" class="slider" id="layersPerBrush" min="10" max="50" value="25">
            </div>

            <div class="control-item">
                <div class="control-label">
                    <span>Brush Size</span>
                    <span class="control-value" id="brushSizeValue">90</span>
                </div>
                <input type="range" class="slider" id="brushSize" min="40" max="150" value="90">
            </div>
        </div>

        <div class="control-section">
            <div class="section-header">Watercolor FX</div>
            
            <div class="control-item">
                <div class="control-label">
                    <span>Edge Complexity</span>
                    <span class="control-value" id="edgeComplexityValue">4</span>
                </div>
                <input type="range" class="slider" id="edgeComplexity" min="2" max="6" value="4">
            </div>

            <div class="control-item">
                <div class="control-label">
                    <span>Blur Amount</span>
                    <span class="control-value" id="deformStrengthValue">0.3</span>
                </div>
                <input type="range" class="slider" id="deformStrength" min="0.1" max="0.6" step="0.1" value="0.3">
            </div>

            <div class="control-item">
                <div class="control-label">
                    <span>Layer Opacity</span>
                    <span class="control-value" id="opacityValue">8</span>
                </div>
                <input type="range" class="slider" id="opacity" min="4" max="15" value="8">
            </div>
        </div>

        <div class="control-section">
            <div class="section-header">Settings</div>
            
            <div class="control-item">
                <div class="control-label">
                    <span>Random Seed</span>
                    <span class="control-value" id="randomSeedValue">42</span>
                </div>
                <input type="range" class="slider" id="randomSeed" min="1" max="1000" value="42">
            </div>

            <div class="control-item">
                <div class="control-label">
                    <span>Background</span>
                </div>
                <select class="dropdown" id="backgroundType">
                    <option value="white">White</option>
                    <option value="paper">Paper Texture</option>
                    <option value="gradient">Gradient</option>
                </select>
            </div>
        </div>

        <div class="button-group">
            <button class="btn btn-primary" onclick="generateNew()">Generate</button>
            <button class="btn btn-secondary" onclick="savePNG()">Export PNG</button>
        </div>

        <div class="version-info">v2.0 • Tyler Hobbs Algorithm</div>
    </div>

    <div class="canvas-container">
        <div class="canvas-wrapper" id="canvasWrapper"></div>
        
        <div class="canvas-metadata">
            <div class="primary-info" id="canvasInfo">800 × 600px</div>
            <div class="secondary-info" id="generationInfo">Generated with <span id="currentPaletteInfo">vibrant</span> palette • <span id="layerCountInfo">300</span> total layers</div>
        </div>
    </div>

    <script>
        console.log("🎨 Waterscape Studio v2.0 initializing...");

        // Color palettes
        const palettes = {
            vibrant: ['#FF6B6B', '#4ECDC4', '#45B7D1', '#FFA07A', '#98D8C8', '#F7DC6F', '#BB8FCE', '#85C1E9'],
            pastel: ['#FFB3BA', '#BAFFC9', '#BAE1FF', '#FFFFBA', '#FFDFBA', '#E0BBE4', '#957DAD', '#D291BC'],
            earth: ['#8B4513', '#D2691E', '#CD853F', '#DEB887', '#F4A460', '#D2B48C', '#BC8F8F', '#A0522D'],
            ocean: ['#006994', '#4A90A4', '#83C5BE', '#7FCDCD', '#7FB3D3', '#5D737E', '#3E8E7E', '#1F4E79'],
            sunset: ['#FF4B2B', '#FF416C', '#FFA07A', '#FFB347', '#FFD700', '#FF6347', '#FF69B4', '#FF1493'],
            forest: ['#228B22', '#32CD32', '#7CFC00', '#9ACD32', '#90EE90', '#98FB98', '#00FF7F', '#3CB371'],
            monochrome: ['#2C3E50', '#34495E', '#7F8C8D', '#95A5A6', '#BDC3C7', '#D5DBDB', '#85929E', '#566573']
        };

        let currentPalette = 'vibrant';
        let params = {
            brushCount: 12,
            layersPerBrush: 25,
            brushSize: 90,
            edgeComplexity: 4,
            deformStrength: 0.3,
            opacity: 8,
            randomSeed: 42,
            backgroundType: 'white'
        };

        let canvas;

        // Update metadata display
        function updateMetadata() {
            const totalLayers = params.brushCount * params.layersPerBrush;
            document.getElementById('currentPaletteInfo').textContent = currentPalette;
            document.getElementById('layerCountInfo').textContent = totalLayers;
        }

        // Simple but effective deformation function
        function deformPolygon(vertices, complexity, strength) {
            let result = JSON.parse(JSON.stringify(vertices)); // Deep copy
            
            // Apply multiple rounds of edge subdivision and deformation
            for (let round = 0; round < complexity; round++) {
                let newVertices = [];
                let currentStrength = strength * (1 / (round + 1)); // Reduce strength each round
                
                for (let i = 0; i < result.length; i++) {
                    let current = result[i];
                    let next = result[(i + 1) % result.length];
                    
                    newVertices.push(current);
                    
                    // Create midpoint with random deformation
                    let midX = (current.x + next.x) / 2;
                    let midY = (current.y + next.y) / 2;
                    
                    // Add randomness
                    let deformX = (Math.random() - 0.5) * currentStrength * 40;
                    let deformY = (Math.random() - 0.5) * currentStrength * 40;
                    
                    newVertices.push({
                        x: midX + deformX,
                        y: midY + deformY
                    });
                }
                
                result = newVertices;
            }
            
            return result;
        }

        // Create watercolor brush
        function createWatercolorBrush() {
            try {
                let x = random(width * 0.2, width * 0.8);
                let y = random(height * 0.2, height * 0.8);
                let size = random(params.brushSize * 0.7, params.brushSize * 1.3);
                let sides = int(random(6, 10));
                
                // Pick random color
                let colorIndex = int(random(palettes[currentPalette].length));
                let baseColor = palettes[currentPalette][colorIndex];
                
                // Parse color
                let r = parseInt(baseColor.slice(1, 3), 16);
                let g = parseInt(baseColor.slice(3, 5), 16);
                let b = parseInt(baseColor.slice(5, 7), 16);
                
                // Add variation
                r = constrain(r + random(-20, 20), 0, 255);
                g = constrain(g + random(-20, 20), 0, 255);
                b = constrain(b + random(-20, 20), 0, 255);
                
                // Create base polygon
                let basePolygon = [];
                for (let i = 0; i < sides; i++) {
                    let angle = (TWO_PI / sides) * i;
                    let vx = x + cos(angle) * size;
                    let vy = y + sin(angle) * size;
                    basePolygon.push({x: vx, y: vy});
                }
                
                // Apply deformation
                basePolygon = deformPolygon(basePolygon, params.edgeComplexity, params.deformStrength);
                
                return {
                    basePolygon: basePolygon,
                    r: r,
                    g: g,
                    b: b,
                    x: x,
                    y: y,
                    size: size
                };
            } catch (error) {
                console.error("Error creating brush:", error);
                return null;
            }
        }

        // Draw watercolor layer
        function drawWatercolorLayer(brush) {
            try {
                if (!brush) return;
                
                // Create slight variation for this layer
                let layerPolygon = brush.basePolygon.map(v => ({
                    x: v.x + random(-2, 2),
                    y: v.y + random(-2, 2)
                }));
                
                // Apply minor additional deformation
                layerPolygon = deformPolygon(layerPolygon, 2, params.deformStrength * 0.5);
                
                // Set color with low opacity
                fill(brush.r, brush.g, brush.b, params.opacity);
                noStroke();
                
                // Draw the shape
                beginShape();
                for (let v of layerPolygon) {
                    vertex(v.x, v.y);
                }
                endShape(CLOSE);
                
            } catch (error) {
                console.error("Error drawing layer:", error);
            }
        }

        function generateWaterscape() {
            try {
                console.log("🎨 Generating waterscape...", params);
                
                randomSeed(params.randomSeed);
                
                // Clear canvas
                background(255);
                drawBackground();
                
                // Create brushes
                let brushes = [];
                for (let i = 0; i < params.brushCount; i++) {
                    let brush = createWatercolorBrush();
                    if (brush) {
                        brushes.push(brush);
                    }
                }
                
                console.log(`✨ Created ${brushes.length} brushes`);
                
                if (brushes.length === 0) {
                    throw new Error("No brushes created");
                }
                
                // Draw layers
                for (let layer = 0; layer < params.layersPerBrush; layer++) {
                    for (let brush of brushes) {
                        drawWatercolorLayer(brush);
                    }
                }
                
                // Update metadata
                updateMetadata();
                
                console.log("🎨 Generation complete!");
                
            } catch (error) {
                console.error('❌ Generation error:', error);
                
                // Simple fallback that shows something
                background(255);
                
                // Draw some basic watercolor-like shapes
                for (let i = 0; i < 5; i++) {
                    let colorIndex = int(random(palettes[currentPalette].length));
                    let baseColor = palettes[currentPalette][colorIndex];
                    let r = parseInt(baseColor.slice(1, 3), 16);
                    let g = parseInt(baseColor.slice(3, 5), 16);
                    let b = parseInt(baseColor.slice(5, 7), 16);
                    
                    fill(r, g, b, 30);
                    noStroke();
                    
                    let x = random(width * 0.2, width * 0.8);
                    let y = random(height * 0.2, height * 0.8);
                    let size = random(50, 150);
                    
                    circle(x, y, size);
                }
                
                updateMetadata();
            }
        }

        function drawBackground() {
            switch (params.backgroundType) {
                case 'white':
                    background(255);
                    break;
                case 'paper':
                    background(252, 248, 240);
                    noStroke();
                    for (let i = 0; i < 200; i++) {
                        fill(240, 235, 220, random(10, 30));
                        circle(random(width), random(height), random(0.5, 2));
                    }
                    break;
                case 'gradient':
                    for (let y = 0; y < height; y++) {
                        let alpha = map(y, 0, height, 0, 1);
                        let r = lerp(255, 240, alpha);
                        let g = lerp(255, 248, alpha);
                        let b = lerp(255, 255, alpha);
                        stroke(r, g, b);
                        line(0, y, width, y);
                    }
                    break;
                default:
                    background(255);
            }
        }

        // UI Functions
        function updateColorPalette() {
            const paletteDiv = document.getElementById('colorPalette');
            if (!paletteDiv) return;
            
            paletteDiv.innerHTML = '';
            
            palettes[currentPalette].forEach((color, index) => {
                const swatch = document.createElement('div');
                swatch.className = 'color-swatch';
                swatch.style.backgroundColor = color;
                swatch.title = color;
                paletteDiv.appendChild(swatch);
            });
        }

        function setupControls() {
            console.log("🎛️ Setting up controls...");
            
            // Palette selector
            const paletteSelect = document.getElementById('paletteSelect');
            if (paletteSelect) {
                paletteSelect.addEventListener('change', (e) => {
                    currentPalette = e.target.value;
                    updateColorPalette();
                    generateNew();
                });
            }

            // Parameter controls
            Object.keys(params).forEach(param => {
                const control = document.getElementById(param);
                const valueDisplay = document.getElementById(param + 'Value');
                
                if (control && valueDisplay) {
                    control.addEventListener('input', (e) => {
                        params[param] = param === 'deformStrength' ? 
                            parseFloat(e.target.value) : 
                            parseInt(e.target.value);
                        
                        valueDisplay.textContent = 
                            param === 'deformStrength' ? 
                            params[param].toFixed(1) : 
                            params[param];
                        
                        generateNew();
                    });
                }
            });

            // Background type
            const backgroundType = document.getElementById('backgroundType');
            if (backgroundType) {
                backgroundType.addEventListener('change', (e) => {
                    params.backgroundType = e.target.value;
                    generateNew();
                });
            }
        }

        function setup() {
            try {
                console.log("🚀 Setting up canvas...");
                canvas = createCanvas(800, 600);
                canvas.parent('canvasWrapper');
                
                console.log("✅ Canvas created successfully");
                
                setTimeout(() => {
                    setupControls();
                    updateColorPalette();
                    generateWaterscape();
                }, 200);
                
            } catch (error) {
                console.error('❌ Setup error:', error);
            }
        }

        function generateNew() {
            console.log("🔄 Generate new called");
            generateWaterscape();
        }

        function savePNG() {
            try {
                if (canvas) {
                    console.log("💾 Exporting PNG...");
                    saveCanvas(canvas, `waterscape_${Date.now()}`, 'png');
                }
            } catch (error) {
                console.error('❌ Export error:', error);
                alert('Error saving image. Please try again.');
            }
        }

        function draw() {
            // Static generation
        }

        // Error handling
        window.onerror = function(msg, url, lineNo, columnNo, error) {
            console.error('❌ JavaScript Error:', msg, 'at line', lineNo);
            return false;
        };

        console.log("✅ Waterscape Studio loaded successfully");
    </script>
</body>
</html>